<!DOCTYPE html>
<html>

<head>
  <title>API Request Form</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.0.2/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    $(document).ready(function () {
      // Seleciona o formulário e o div result
      const form = $('form');
      const result = $('#result');

      // Adiciona o evento de submit no formulário
      form.on('submit', function (event) {
        event.preventDefault();

        // Obtém o valor do campo de texto
        const id = $('#system').val();

        // Faz a chamada para a API /platforms
        $.get(`http://localhost:8080/platforms/${id}`, function (data) {
          // Cria a lista de jogos
          const system = $('#system option:selected').text();
          const games = data.map(game => {
            const url = `http://localhost:8080/download/${system}?arquivo=${id}/${encodeURIComponent(game.arquivo)}`;
            return `<li class="py-3"><a href="${url}" class="download-link">${game.nome}</a></li>`;
          }).join('');

          // Insere a lista no div result
          result.html(`<ul class="divide-y divide-gray-200">${games}</ul>`);

          // Mostra o div result
          result.removeClass('hidden');

          // define a função que atualizará a barra de download
          function updateProgressBar () {
            $.get('/progress', function (data) {
              var progress = parseInt(data.progress);
              $('.progress-bar').css('width', progress + '%').attr('aria-valuenow', progress);
              if (progress < 100) {
                setTimeout(updateProgressBar, 1000);
              } else {
                $('.progress').removeClass('active');
                $('.progress-bar').text('Download Concluído');
                setTimeout(function () {
                  $('.progress').hide();
                }, 1000);
              }
            });
          }
          setTimeout(updateProgressBar, 1000);


          // Adiciona o evento de click nos links de download
          $(document).on('click', '.download-link', function (event) {
            event.preventDefault();

            // Obtém o URL do arquivo a ser baixado
            const url = $(this).attr('href');

            // Cria um elemento de progresso
            const progress = $('<div>').addClass('bg-gray-300 h-2 rounded-sm mt-10');

            // Insere o elemento de progresso no div result
            $(this).parent().after(progress);

            // Cria um elemento de porcentagem de download
            const percentage = $('<span>').addClass('text-xs ml-2 progress-bar');

            // Insere o elemento de porcentagem de download no div result
            $(this).parent().append(percentage);

            // Faz a requisição AJAX para fazer o download do arquivo
            $.ajax({
              url: url,
              method: 'GET',
              timeout: 10000,
            });
          });
          updateProgressBar()
        });
      });
    })
  </script>

</head>

<body class="min-h-screen bg-gradient-to-b from-blue-500 to-blue-900 bg-no-repeat">
  <div class="mx-auto max-w-screen-lg flex flex-col mt-10">
    <form class="bg-white rounded-lg shadow-md p-4">
      <label for="id">AmberDownloader</label>
      <!-- <input type="text" id="id" name="id" class="ml-2 px-2 py-1 border rounded"> -->
      <select name="system" id="system"
        class="appearance-none bg-white border border-gray-400 hover:border-gray-500 px-4 py-2 pr-8 rounded shadow text-gray-700 w-full mb-3">
        <option value="">-- Selecione um sistema --</option>
        <option value="projeto-launchbox-sony-playstation">psx</option>
        <option value="nointro.gba">gba</option>
        <option value="nointro.gbc">gbc</option>
        <option value="nointro.snes">snes</option>
        <option value="nointro.ms-mkiii">mastersystem</option>
        <option value="nointro.md">megadrive</option>
        <option value="fbnarcade-fullnonmerged">fbneo</option>
        <option value="no-ndsdec2021">nds</option>
        <option value="nointro.n64">n64</option>
        <option value="redump.dc.revival">dreamcast</option>
        <option value="redump.psp">psp</option>
        <option value="scummvm">scummvm</option>
      </select>

      <button
        class="bg-blue-500 hover:bg-blue-700 w-full text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
        type="submit">
        Enviar
      </button>
    </form>
  </div>

  <div class="mx-auto max-w-screen-lg w-full text-center">
    <div id="progress" class="bg-white rounded-lg shadow-md p-4 mt-10 hidden max-w-screen-lg w-full">
      <div id="progress-content"></div>
    </div>
  </div>

  <div class="mx-auto max-w-screen-lg w-full text-center">
    <div id="result" class="bg-white rounded-lg shadow-md p-4 mt-10 hidden max-w-screen-lg w-full">
      <div id="result-content"></div>
    </div>
  </div>

</body>

</html>